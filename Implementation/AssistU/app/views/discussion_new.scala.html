@(title: String)(currentUser:Person)
@defining(PersonData.findActiveProjects()) { activeProjectList =>
    <html lang="en">
        <head>
            @linkLoader.headlinks(title)

        <link rel="stylesheet" type="text/css" href="@routes.Assets.at("../../public/css/discussions.css")">

            <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" ></script>

        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular.min.js"></script>
        <script type="text/javascript">
        'use strict';
        /** app level module which depends on services and controllers */
        angular.module('sseChat', ['sseChat.controllers']);

        angular.module('sseChat', ['sseChat.controllers']).filter('hasSameSubject', function(){
            console.log("Inside filter");
            return function(subcomments, subject){
                var arrayToReturn = [];
                for (var i=0; i<subcomments.length; i++){
                    if (subcomments[i].subject == subject) {
                        arrayToReturn.push(subcomments[i]);
                    }
                }
            return arrayToReturn;
            };
        });
        </script>
        <script id="controller" type="text/javascript">
        'use strict';
        /** Controllers */
        angular.module('sseChat.controllers', []).controller('ChatCtrl', function ($scope, $http) {

            $scope.projectids =[ ];
            $.ajax ( { url : "/projectids", async : false, dataType : 'json', success : function ( response ) { $scope.projectids = response } } ) ;
            $scope.lastpid = "";
            $.ajax ( { url : "/projectid", async : false, dataType : 'json', success : function ( response ) { $scope.lastpid = response } } ) ;
            $scope.comments =[ ] ;
            $.ajax ( { url : "/comments", async : false, dataType : 'json', success : function ( response ) { $scope.comments = response } } ) ;
            console.log("COMMENTS: " + JSON.stringify($scope.comments));
            $scope.subcomments =[ ] ;
            $.ajax ( { url : "/subcomments", async : false, dataType : 'json', success : function ( response ) { $scope.subcomments = response } } ) ;
            console.log("SUBCOMMENTS: " + JSON.stringify($scope.subcomments));

            $scope.message = { } ;
            $scope.message.subject = "" ;
            $scope.message.content = "" ;
            for(var i = 0; i < $scope.comments.length; i++){
                $scope.message["subcomment" + $scope.comments[i].cid] = "";
            }

            $scope.isChild = false ;
            $scope.currentProject = $.grep($scope.projectids, function(p){return p.projectID === $scope.lastpid.projectID;})[0 ];
            console.log("INITIAL ROOM: " + JSON.stringify($scope.currentProject));

            /** change current room, restart EventSource connection */
            $scope.setCurrentProject = function (pid) {
                $scope.currentProject = $.grep($scope.projectids, function(p){return p.projectID === pid;})[0 ];
                console.log("Current Project is set to: " + JSON.stringify($scope.currentProject));
                $scope.chatFeed.close();
                $scope.comments =[ ] ;
                $.ajax ( { url : "/comments", async : false, dataType : 'json', success : function ( response ) { $scope.comments = response } } ) ;
                console.log("COMMENTS: " + JSON.stringify($scope.comments));
                $scope.subcomments =[ ] ;
                $.ajax ( { url : "/subcomments", async : false, dataType : 'json', success : function ( response ) { $scope.subcomments = response } } ) ;
                console.log("SUBCOMMENTS: " + JSON.stringify($scope.subcomments));
                $scope.listen();
            };

            /** change current subject, restart EventSource connection */
            $scope.setCurrentSubjectAndisChild = function (subject, isChild) {
                $scope.message.subject = subject;
                $scope.isChild = isChild;
                console.log("Current Subject and isChild is set to: " + $scope.message.subject + ", " + $scope.isChild);
            };

            $scope.reset = function () {
                $scope.message = {};
                $scope.message.subject = "";
                $scope.message.content = "";
                for(var i = 0; i < $scope.comments.length; i++){
                    $scope.message["subcomment" + $scope.comments[i].cid] = "";
                }
                console.log("input has been reset");
            };

            $scope.setSubmessageAsContent = function (cid) {
                $scope.message.content = $scope.message["subcomment" + cid];
            };

            /** posting chat text to server */
            $scope.submitMsg = function () {
                $http.post("/chat", { subject: $scope.message.subject, content: $scope.message.content,
                                      date: (new Date()).toUTCString(), projectID: $scope.currentProject.projectID, isChild: $scope.isChild});
                console.log("Message has been submitted");
               $scope.reset();
            };

            /** handle incoming messages: add to messages array */
            $scope.addMsg = function (msg) {
                console.log("Adding message: " + JSON.stringify(JSON.parse(msg.data)));
                var newmessage = JSON.parse(msg.data);
                $scope.$apply(function () {
                    if(newmessage["isChild"] === true){
                        console.log("this was a subcomment.");
                        $scope.subcomments.push(newmessage);
                        console.log("SUBCOMMENTS: " + JSON.stringify($scope.subcomments));
                    } else {
                        console.log("this was a regular comment.");
                        $scope.comments.push(newmessage);
                        console.log("COMMENTS: " + JSON.stringify($scope.comments));
                    }
                });
            };

            /** start listening on messages from selected room */
            $scope.listen = function () {
                console.log("Incoming message")
                if($scope.projectids.length > 0) {
                    $scope.chatFeed = new EventSource ( "/chatFeed/" + $scope.currentProject.projectID ) ;
                    $scope.chatFeed.addEventListener ( "message", $scope.addMsg, false ) ;
                }
            };

            $scope.listen();

            $scope.isEqual = function(subcomment, mainsubject){
                console.log("COMPARING " + JSON.stringify(subcomment) + " with " + mainsubject);
                return subcomment.subject == mainsubject;
            }
        });
        </script>
        </head>
        <body>
            <div id="wrapper">
                @dashboard("discussion", currentUser)
                <div id="page-wrapper">
                    @template.headericon("fa fa-comment fa-5x")
                    <div ng-app="sseChat">
                        <div ng-controller="ChatCtrl">
                            <div class="container-fluid" style="text-align: center; margin: 0 0 1% 0">
                                <div role="tabpanel">
                                    <ul class="nav nav-tabs">
                                    @for(p <- activeProjectList) {
                                        @if(p.equals(PersonData.getLastUsedProject)) {
                                            <li role="presentation" class="active" style="width : 18%; text-overflow : ellipsis ; overflow : hidden ; white-space : nowrap">
                                                <a ng-click="setCurrentProject('@p.id')" href="#discussion@p.id" data-toggle="tab">@p.folder</a>
                                            </li>
                                        } else {
                                            <li role="presentation" style="width : 18%; overflow : hidden ; white-space : nowrap ; text-overflow : ellipsis">
                                                <a ng-click="setCurrentProject('@p.id')" href="#discussion@p.id" data-toggle="tab">@p.folder</a>
                                            </li>
                                        }
                                    }
                                    </ul>
                                </div>
                            </div>
                            <div class="tab-content">
                            @for(p <- activeProjectList){
                                @if(p.equals(PersonData.getLastUsedProject)){
                                    <div class="tab-pane fade in active" id="discussion@p.id">
                                    } else {
                                    <div class="tab-pane fade" id="discussion@p.id">
                                    }
                                        <div class="row">
                                            <div class="col-xs-10">
                                                <h3 style="margin: 5px 0 0 30px;"><u>Discussions</u></h3>
                                            </div>
                                            <div class="col-xs-2">
                                                <button ng-click="setCurrentSubjectAndisChild('', false);" class="btn btn-success pull-right" data-toggle="collapse" data-target="#comment@p.id" style="margin: 0; margin-right: 30px;">Start new Discussion</button>
                                            </div>
                                        </div>
                                        <hr class="hr" style="margin: 15px 15px 0">
                                        <div id="comment@p.id" class="panel-footer collapse" style="margin-left: -30px; margin-right: -30px; padding: 15px 50px 50px">
                                            <div class="row" style="padding: 0; text-align: center">
                                                <button type="button" class="close pull-right" data-toggle="collapse" data-target="#comment@p.id" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                <h3 style="padding: 0; margin: 0">Start a new Discussion</h3>
                                            </div>
                                            <div class="row" style="padding: 0 20px">
                                                Subject:
                                            </div>
                                            <div class="row" style="padding: 0 20px 5px 20px;">
                                                <span class="input-group-btn">
                                                    <input type="text" name="chat" id="textField" ng-model="message.subject"
                                                    placeholder="Your eye-catching subject title here..." class="ng-pristine ng-valid form-control input-sm"/>
                                                </span>
                                            </div>
                                            <div class="row" style="padding: 0 20px">
                                                Comment:
                                            </div>
                                            <div class="row" style="padding: 0 20px">
                                                <span class="input-group-btn">
                                                    <input ng-submit="submitMsg()" type="text" name="chat" id="textField" ng-model="message.content"
                                                    placeholder="Your text here..." class="ng-pristine ng-valid form-control input-sm"/>
                                                </span>
                                            </div>
                                            <div class="row pull-right" style="margin: 10px">
                                                <button ng-click="reset();" class="btn btn-default btn-sm"
                                                data-toggle="collapse" data-target="#comment@p.id" type="button" style="width: 80px">Cancel</button>
                                                <button type="button" class="btn btn-success btn-sm" style="width: 80px"
                                                id="saySomething" data-toggle="collapse" data-target="#comment@p.id" ng-click="submitMsg()">Submit</button>
                                            </div>
                                        </div>
                                        <div class="panel-body" style="padding: 0">

                                            <ul class="timeline" style="margin-right: 30px; margin-bottom: 0; height: 80%">
                                                <li class="{{comment.who}} comment" ng-repeat="comment in comments | filter:{projectID: @p.id}">
                                                    <div class="timeline-badge primary" ng-if="comment.role=='Owner'">
                                                        <i class="fa fa-user" style="margin-top: 13px"></i>
                                                    </div>
                                                    <div class="timeline-badge success" ng-if="comment.role=='Reviewer'">
                                                        <i class="fa fa-edit" style="margin-top: 13px"></i>
                                                    </div>
                                                    <div class="timeline-panel">
                                                        <div class="timeline-heading">
                                                            <a class="btn btn-info pull-right" data-toggle="collapse" href="#showSubCommentsOf{{comment.cid}}" aria-expanded="false" aria-controls="collapseExample">
                                                                Show
                                                            </a>
                                                            <h4 class="timeline-title" style="margin-left: 10px; margin-bottom: 0">
                                                                <u>{{comment.subject}}</u>
                                                                <br>
                                                                <p style="font-size: x-small; margin-bottom: 0; margin-top: 4px">(by {{comment.username}})</p>
                                                            </h4>
                                                        </div>
                                                        <div class="collapse" id="showSubCommentsOf{{comment.cid}}">
                                                            <hr class="hr" style="margin: 15px 0 10px">
                                                            <div class="container-fluid" style="margin-bottom: 20px; padding-right: 0">
                                                                <small class="pull-right text-muted" style="margin-right: 4px">
                                                                    <i class="fa fa-clock-o fa-fw" title="{{comment.date}}"></i>
                                                                </small>
                                                                {{comment.content}}
                                                            </div>

                                                            <div class="container-fluid" ng-repeat="subcomment in subcomments | hasSameSubject:comment.subject" style="padding: 0">
                                                                <hr class="hr" style="margin: 5px 0">
                                                                <div class="container-fluid" style="padding-right: 0">
                                                                    <small class="pull-right text-muted" style="margin-top: 4px; margin-right: 4px">
                                                                        <i class="fa fa-clock-o fa-fw" title="{{subcomment.date}}"></i>
                                                                    </small>
                                                                    <b>{{subcomment.username}}</b> - {{subcomment.content}}
                                                                </div>
                                                            </div>
                                                            <div class="panel-footer" style="margin-left: -15px; margin-right: -15px; margin-bottom: -15px; margin-top: 5px">
                                                                <div class="input-group">
                                                                    <input id="btn-input" type="text" class="form-control input-sm" placeholder="@currentUser.name says..."
                                                                    ng-click="reset(); setCurrentSubjectAndisChild(comment.subject, true)" ng-model="message['subcomment' + comment.cid]"/>
                                                                    <span class="input-group-btn">
                                                                        <button class="btn btn-warning btn-sm" ng-click="setSubmessageAsContent(comment.cid);submitMsg()">React!</button>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!--bootstrap-->
            <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

                <!--sb-Admin-->
            <script src="@routes.Assets.at("javascripts/sb-admin-2.js")"></script>

            <script src="@routes.Assets.at("javascripts/plugins/metisMenu/metisMenu.min.js")"></script>
        </body>
    </html>
}